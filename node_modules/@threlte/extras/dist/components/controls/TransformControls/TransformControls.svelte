<script>import { forwardEventHandlers, HierarchicalObject, T, useThrelte, watch } from '@threlte/core';
import { omit, pick } from 'lodash-es';
import { derived, writable } from 'svelte/store';
import { Group } from 'three';
import { TransformControls } from 'three/examples/jsm/controls/TransformControls';
import { useControlsContext } from '../useControlsContext';
export let autoPauseOrbitControls = true;
export let object = undefined;
const { camera, renderer, invalidate, scene } = useThrelte();
const { orbitControls } = useControlsContext();
const isDragging = writable(false);
const useAutoPauseOrbitControls = writable(autoPauseOrbitControls) ?? true;
$: useAutoPauseOrbitControls.set(autoPauseOrbitControls ?? true);
const onDraggingChanged = (e) => {
    isDragging.set(e.value);
};
watch([orbitControls, isDragging, useAutoPauseOrbitControls], ([orbitControls, isDragging, useAutoPauseOrbitControls]) => {
    // if there are no orbitcontrols or we're not even
    // dragging, or the orbitcontrols are disabled, return
    if (!orbitControls || (!orbitControls.enabled && isDragging))
        return;
    orbitControls.enabled = !(isDragging && useAutoPauseOrbitControls);
    return () => {
        // we know they were enabled before, so we can
        // safely re-enable them
        orbitControls.enabled = true;
    };
});
export const group = new Group();
const controlsStore = derived(camera, (camera) => {
    return new TransformControls(camera, renderer.domElement);
});
export let controls = $controlsStore;
$: controls = $controlsStore;
const attachTo = writable(object ?? group);
watch([controlsStore, attachTo], ([controls, attachTo]) => {
    controls.attach(attachTo);
    return () => {
        controls.detach();
    };
});
// This component is receiving the props for the controls as well as the props
// for the group, so we need to split them up
const transformOnlyPropNames = [
    'enabled',
    'axis',
    'mode',
    'translationSnap',
    'rotationSnap',
    'scaleSnap',
    'space',
    'size',
    'showX',
    'showY',
    'showZ',
    'visible'
];
$: transformProps = pick($$restProps, transformOnlyPropNames);
$: objectProps = omit($$restProps, transformOnlyPropNames);
const component = forwardEventHandlers();
</script>

<!-- TransformControls need to be added to the scene -->
<HierarchicalObject
  onChildMount={(child) => {
    scene.add(child)
  }}
  onChildDestroy={(child) => {
    scene.remove(child)
  }}
>
  <T
    is={$controlsStore}
    on:dragging-changed={onDraggingChanged}
    on:change={invalidate}
    {...transformProps}
    bind:this={$component}
  />
</HierarchicalObject>

<T
  is={group}
  let:ref
  {...objectProps}
>
  <slot {ref} />
</T>
